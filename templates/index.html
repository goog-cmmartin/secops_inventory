<!DOCTYPE html>
<html lang="en" class="">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SecOps Inventory</title>
    <link rel="icon" type="image/svg+xml" href="/static/icons/security.svg">

    <link href="/static/css/output.css" rel="stylesheet" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css"
      rel="stylesheet"
    />
    <link href="/static/lib/tom-select/tom-select.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="/static/lib/tom-select/tom-select.complete.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.2.7/purify.min.js"></script>
  </head>
  <body class="bg-gray-100 dark:bg-gray-900">
    <div class="container mx-auto p-4">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center">
          <img src="/static/icons/chronicle.svg" class="h-6 w-6 mr-2">
          SecOps Inventory
        </h1>
          <div class="flex items-center">
            <div id="active-tenant-chip" class="hidden items-center px-3 py-1.5 me-2 text-sm font-medium text-gray-800 bg-gray-100 rounded-full dark:bg-gray-700 dark:text-gray-300">
                <span class="w-2.5 h-2.5 bg-green-500 rounded-full me-1.5 flex-shrink-0"></span>
                <span id="active-tenant-chip-text"></span>
            </div>
            <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5">
              <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
              <svg id="theme-toggle-light-icon-svg" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05a1 1 0 010 1.414l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 0zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
            </button>
          </div>
      </div>

      <div class="mb-4 border-b border-gray-200 dark:border-gray-700">
        <ul
          class="flex flex-wrap -mb-px text-sm font-medium text-center"
          id="myTab"
          data-tabs-toggle="#myTabContent"
          role="tablist"
        >
          <li class="mr-2" role="presentation">
            <button
              class="inline-block p-4 border-b-2 rounded-t-lg"
              id="home-tab"
              data-tabs-target="#home"
              type="button"
              role="tab"
              aria-controls="home"
              aria-selected="false"
            >
              Home
            </button>
          </li>
          <li class="mr-2" role="presentation">
            <button
              class="inline-block p-4 border-b-2 rounded-t-lg"
              id="tenants-tab"
              data-tabs-target="#tenants"
              type="button"
              role="tab"
              aria-controls="tenants"
              aria-selected="false"
            >
              Tenants
            </button>
          </li>
          <li role="presentation">
            <button
              class="inline-block p-4 border-b-2 rounded-t-lg"
              id="audits-tab"
              data-tabs-target="#audits"
              type="button"
              role="tab"
              aria-controls="audits"
              aria-selected="false"
            >
              Audits
            </button>
          </li>
          <li role="presentation">
            <button
              class="inline-block p-4 border-b-2 rounded-t-lg"
              id="insights-tab"
              data-tabs-target="#insights"
              type="button"
              role="tab"
              aria-controls="insights"
              aria-selected="false"
            >
              Insights
            </button>
          </li>
          <li role="presentation">
            <button
              class="inline-block p-4 border-b-2 rounded-t-lg"
              id="reports-tab"
              data-tabs-target="#reports"
              type="button"
              role="tab"
              aria-controls="reports"
              aria-selected="false"
            >
              Reports
            </button>
          </li>
          <li role="presentation">
            <button
              class="inline-block p-4 border-b-2 rounded-t-lg"
              id="mcp-assistant-tab"
              data-tabs-target="#mcp-assistant"
              type="button"
              role="tab"
              aria-controls="mcp-assistant"
              aria-selected="false"
            >
              MCP Assistant
            </button>
          </li>
          <li role="presentation">
            <button
              class="inline-block p-4 border-b-2 rounded-t-lg"
              id="schedules-tab"
              data-tabs-target="#schedules"
              type="button"
              role="tab"
              aria-controls="schedules"
              aria-selected="false"
            >
              Schedules
            </button>
          </li>
          <li role="presentation">
            <button
              class="inline-block p-4 border-b-2 rounded-t-lg"
              id="settings-tab"
              data-tabs-target="#settings"
              type="button"
              role="tab"
              aria-controls="settings"
              aria-selected="false"
            >
              Settings
            </button>
          </li>
          <li class="mr-2" role="presentation">
            <button
              class="inline-block p-4 border-b-2 rounded-t-lg"
              id="api-explorer-tab"
              data-tabs-target="#api-explorer"
              type="button"
              role="tab"
              aria-controls="api-explorer"
              aria-selected="false"
            >
              API Explorer
            </button>
          </li>
          <li role="presentation">
            <button
              class="inline-block p-4 border-b-2 rounded-t-lg"
              id="help-tab"
              data-tabs-target="#help"
              type="button"
              role="tab"
              aria-controls="help"
              aria-selected="false"
            >
              Help
            </button>
          </li>
        </ul>
      </div>
      <div id="myTabContent">
        {% include 'tabs/home.html' %}
        {% include 'tabs/tenants.html' %}
        {% include 'tabs/api_explorer.html' %}
        {% include 'tabs/audits.html' %}
        {% include 'tabs/insights.html' %}
        {% include 'tabs/schedules.html' %}
        {% include 'tabs/settings.html' %}
        {% include 'tabs/reports.html' %}
        {% include 'tabs/mcp_assistant.html' %}
        {% include 'tabs/help.html' %}
      </div>
    </div>

    <!-- Modals Container -->
    <div id="modals-container">
      {% include 'modals/json_viewer.html' %}
      {% include 'modals/schedule.html' %}
      {% include 'modals/compare_runs.html' %}
      {% include 'modals/insight.html' %}
      {% include 'modals/report_viewer.html' %}
      {% include 'modals/config.html' %}
      {% include 'modals/yl2_query.html' %}
      {% include 'modals/configurable_audit.html' %}
      {% include 'modals/setup_wizard.html' %}
      {% include 'modals/llm_edit.html' %}
    </div>

    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2"></div>

    <script>
      // --- Global Modal Instances ---
      let configModal,
        reportViewerModal,
        insightModal,
        jsonViewerModal,
        yl2QueryModal,
        setupWizardModal,
        scheduleModal,
        compareRunsModal,
        configurableAuditModal,
        llmEditModal;
      let insightAuditSelect;

      // --- Global Element & State References ---
      let dbStatus, tenantsTable, tenantData, availableAudits;
      let tenantSelect,
        auditTenantSelect,
        insightTenantSelect,
        reportTenantFilter;
      let TOOL_REGISTRY = {}; // For MCP Assistant

      // --- MAIN SCRIPT ---
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM fully loaded and parsed");

        async function fetchAvailableTools() {
          try {
            const response = await fetch("/api/mcp/tools");
            if (!response.ok) throw new Error("Failed to fetch MCP tools.");
            const data = await response.json();
            TOOL_REGISTRY = data.tools;
            console.log("Fetched MCP Tools:", TOOL_REGISTRY);
          } catch (error) {
            console.error("Error fetching MCP tools:", error);
            showToast("Could not load MCP Assistant tools.", "warning");
          }
        }

        // --- Element References ---
        const setupTab = document.getElementById("setup");
        dbStatus = document.getElementById("db-status");
        tenantsTable = document.getElementById("tenants-table");
        insightTenantSelect = document.getElementById("insight-tenant-select");
        tenantSelect = document.getElementById("tenant-select");
        auditTenantSelect = document.getElementById("audit-tenant-select");
        reportTenantFilter = document.getElementById("report-tenant-filter");

        // --- State Variables ---
        tenantData = [];
        availableAudits = {};

        // --- Initialization ---
        function initializeModals() {
          configModal = new Modal(document.getElementById("config-modal"));
          reportViewerModal = new Modal(
            document.getElementById("report-viewer-modal")
          );
          insightModal = new Modal(document.getElementById("insight-modal"));
          jsonViewerModal = new Modal(
            document.getElementById("json-viewer-modal")
          );
          yl2QueryModal = new Modal(document.getElementById("yl2-query-modal"));
          configurableAuditModal = new Modal(
            document.getElementById("configurable-audit-modal")
          );
          scheduleModal = new Modal(document.getElementById("schedule-modal"));
          compareRunsModal = new Modal(document.getElementById("compare-runs-modal"));
          llmEditModal = new Modal(document.getElementById("llm-edit-modal"));
          // Setup Wizard Modal is persistent and not dismissable by default
          setupWizardModal = new Modal(
            document.getElementById("setup-wizard-modal"),
            { closable: false }
          );
        }

        document
          .getElementById("reports-tab")
          .addEventListener("click", fetchReports);

        // --- Settings Sub-Tabs Initialization ---
        const settingsTabsElement = document.getElementById('settingsTab');
        const settingsTabItems = [
            { id: 'llm-settings', triggerEl: document.getElementById('llm-settings-tab'), targetEl: document.getElementById('llm-settings') },
            { id: 'yl2-settings', triggerEl: document.getElementById('yl2-settings-tab'), targetEl: document.getElementById('yl2-settings') },
            { id: 'configurable-audits', triggerEl: document.getElementById('configurable-audits-tab'), targetEl: document.getElementById('configurable-audits') },
            { id: 'data-management', triggerEl: document.getElementById('data-management-tab'), targetEl: document.getElementById('data-management') }
        ];

        const settingsTabOptions = {
            onShow: (tabs, tab) => { // Corrected signature
                if (!tab || !tab.id) return; // Guard against undefined objects
                console.log(tab.id + ' tab is shown');
                if (tab.id === 'llm-settings') {
                    populateLlmSettings();
                } else if (tab.id === 'yl2-settings') {
                    fetchCustomYl2Queries();
                } else if (tab.id === 'configurable-audits') {
                    fetchConfigurableAudits();
                }
            }
        };

        const settingsTabs = new Tabs(settingsTabsElement, settingsTabItems, settingsTabOptions);

        // Manually trigger the show event for the active tab on page load
        const activeTab = settingsTabs.getActiveTab();
        if(activeTab) {
            // Pass both arguments to match the expected signature
            settingsTabOptions.onShow(settingsTabs, activeTab);
        }

        // --- Setup Wizard Functions ---
        window.runTenantDiscovery = async function () {
          const orgId = document.getElementById("organization-id-input").value;
          if (!orgId) {
            showToast("Please enter a GCP Organization ID.", "warning");
            return;
          }
          document.getElementById("wizard-step-2").classList.add("hidden");
          document.getElementById("wizard-step-3").classList.remove("hidden");
          document.getElementById("wizard-status-message").textContent =
            "Starting tenant discovery... This may take a few minutes.";

          try {
            const response = await fetch("/api/setup/discover_tenants", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ organization_id: orgId }),
            });
            const result = await response.json();
            if (!response.ok) {
              throw new Error(result.detail || "Failed to start discovery.");
            }
            // Start polling for the task status
            pollSetupStatus(result.task_id);
          } catch (error) {
            document.getElementById(
              "wizard-status-message"
            ).textContent = `Error: ${error.message}`;
            showToast(error.message, "error");
          }
        };

        function pollSetupStatus(taskId) {
          const statusMessageEl = document.getElementById(
            "wizard-status-message"
          );
          const finishButton = document.getElementById("wizard-finish-button");
          const progressIndicator = document.getElementById(
            "wizard-progress-indicator"
          );

          const interval = setInterval(async () => {
            try {
              // We can reuse the report status endpoint as it's generic
              const response = await fetch(`/api/reports/status/${taskId}`);
              if (!response.ok) {
                // Stop polling on server error
                clearInterval(interval);
                statusMessageEl.textContent =
                  "Error checking discovery status. Please check server logs and reload.";
                finishButton.textContent = "Close";
                finishButton.classList.remove("hidden");
                return;
              }
              const result = await response.json();

              statusMessageEl.textContent = result.status;

              if (result.state === "SUCCESS") {
                clearInterval(interval);
                progressIndicator.classList.add("hidden");
                statusMessageEl.textContent =
                  "Discovery complete! Click Finish to reload the application.";
                finishButton.classList.remove("hidden");
              } else if (result.state === "FAILURE") {
                clearInterval(interval);
                progressIndicator.classList.add("hidden");
                statusMessageEl.textContent = `Error during discovery: ${result.status}`;
                finishButton.textContent = "Close & Retry";
                finishButton.classList.remove("hidden");
              }
            } catch (error) {
              clearInterval(interval);
              progressIndicator.classList.add("hidden");
              statusMessageEl.textContent =
                "Error checking discovery status. Please check the server logs and reload.";
              finishButton.textContent = "Close & Retry";
              finishButton.classList.remove("hidden");
            }
          }, 3000); // Poll every 3 seconds
        }

        window.runDbInitialization = async function () {
          document.getElementById("wizard-step-1").classList.add("hidden");
          document.getElementById("wizard-step-3").classList.remove("hidden");
          document.getElementById("wizard-status-message").textContent =
            "Initializing database...";

          try {
            const response = await fetch("/api/setup/initialize_db", {
              method: "POST",
            });
            if (!response.ok) {
              const err = await response.json();
              throw new Error(err.detail || "Database initialization failed.");
            }
            document.getElementById("wizard-step-3").classList.add("hidden");
            document.getElementById("wizard-step-2").classList.remove("hidden");
          } catch (error) {
            document.getElementById(
              "wizard-status-message"
            ).textContent = `Error: ${error.message}`;
            showToast(error.message, "error");
          }
        };

        async function handleManualTenantSubmit(event) {
          event.preventDefault();
          const projectId = document.getElementById("manual-project-id").value;
          const displayName = document.getElementById(
            "manual-display-name"
          ).value;

          try {
            const response = await fetch("/api/setup/manual_tenant", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                project_id: projectId,
                display_name: displayName,
              }),
            });
            if (!response.ok) {
              const err = await response.json();
              throw new Error(err.detail || "Failed to add tenant.");
            }
            showToast("Tenant added successfully! Reloading...", "success");
            setTimeout(() => window.location.reload(), 2000);
          } catch (error) {
            showToast(error.message, "error");
          }
        }

        // --- Initial Application Load ---

        initializeModals();

        fetchTenants();

        fetchAvailableTools();

        // Re-add MCP listeners

        document
          .getElementById("mcp-chat-form")
          .addEventListener("submit", handleChatSubmit);

        document
          .getElementById("chat-input")
          .addEventListener("input", handleChatInput);
      });
    </script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/tenants.js"></script>
    <script src="/static/js/api.js"></script>
    <script src="/static/js/audits.js"></script>
    <script src="/static/js/reports.js"></script>
    <script src="/static/js/insights.js"></script>
    <script src="/static/js/yl2_queries.js"></script>
    <script src="/static/js/llm_settings.js"></script>
    <script src="/static/js/data_management.js"></script>
    <script src="/static/js/schedules.js"></script>
    <script src="/static/js/mcp.js"></script>
    <script src="/static/js/help.js"></script>
    <script src="/static/js/theme.js"></script>
    <script src="/static/js/dashboard.js"></script>
  </body>
</html>